.. Copyright 2015 tsuru-client authors. All rights reserved.
   Use of this source code is governed by a BSD-style
   license that can be found in the LICENSE file.

**tsuru** is the command line utility used by application developers, that
will allow users to create, list, bind and manage apps.

Installing
==========

There are several ways to install `tsuru-client`:

- `Downloading binaries (Mac OS X and Linux)`_
- `Using homebrew (Mac OS X only)`_
- `Using the PPA (Ubuntu only)`_
- `Using AUR (ArchLinux only)`_
- `Build from source (Linux and Mac OS X)`_

Downloading binaries (Mac OS X and Linux)
-----------------------------------------

We provide pre-built binaries for OS X and Linux, only for the amd64
architecture. You can download these binaries directly from the releases page
of the project:

    * tsuru: https://github.com/tsuru/tsuru-client/releases

Using homebrew (Mac OS X only)
------------------------------

If you use Mac OS X and `homebrew <http://mxcl.github.com/homebrew/>`_, you may
use a custom tap to install ``tsuru``. First you need to add the tap:

.. highlight:: bash

::

    $ brew tap tsuru/homebrew-tsuru

Now you can install tsuru:

.. highlight:: bash

::

    $ brew install tsuru

Whenever a new version of any of tsuru's clients is out, you can just run:

.. highlight:: bash

::

    $ brew update
    $ brew upgrade tsuru

For more details on taps, check `homebrew documentation
<https://github.com/Homebrew/homebrew/wiki/brew-tap>`_.

**NOTE:** tsuru requires Go 1.2 or higher. Make sure you have the last version
of Go installed in your system.

Using the PPA (Ubuntu only)
---------------------------

Ubuntu users can install tsuru clients using ``apt-get`` and the `tsuru PPA
<https://launchpad.net/~tsuru/+archive/ppa>`_. You'll need to add the PPA
repository locally and run an ``apt-get update``:

.. highlight:: bash

::

    $ sudo apt-add-repository ppa:tsuru/ppa
    $ sudo apt-get update

Now you can install tsuru's clients:

.. highlight:: bash

::

    $ sudo apt-get install tsuru-client

Using AUR (ArchLinux only)
--------------------------

Archlinux users can build and install tsuru client from AUR repository,
Is needed to have installed `yaourt <http://archlinux.fr/yaourt-en>`_ program.

You can run:


.. highlight:: bash

::

    $ yaourt -S tsuru

Build from source (Linux and Mac OS X)
--------------------------------------

.. note::

    If you're feeling adventurous, you can try it on other systems, like
    FreeBSD, OpenBSD or even Windows. Please let us know about your progress!

`tsuru client source <https://github.com/tsuru/tsuru-client>`_ is written in `Go
<http://golang.org>`_, so before installing tsuru from source, please make sure
you have `installed and configured Go <http://golang.org/doc/install>`_.

With Go installed and configured, you can use ``go get`` to install any of
tsuru's clients:

.. highlight:: bash

::

    $ go get github.com/tsuru/tsuru-client/tsuru

Managing remote tsuru server endpoints
======================================

The target is the **tsuru** server to which all operations will be directed to.

.. highlight:: bash

::

    $ tsuru target-add <label> <address> [--set-current|-s]
    $ tsuru target-list
    $ tsuru target-set <label>
    $ tsuru target-remove <label>

With this set of commands you are be able to add a new labeled target,
set a target for usage, list the added targets and remove a target, respectively.

Check current version
=====================

To see the current version of **tsuru** you should use the `version` command:

.. highlight:: bash

::

    $ tsuru version
    tsuru version 0.14.0.

Authentication
==============

Create a user
-------------

.. highlight:: bash

::

    $ tsuru user-create <email>

`user-create` creates a user within tsuru remote server. It will ask for the password before issue the request.

Remove your user from tsuru server
----------------------------------

.. highlight:: bash

::

    $ tsuru user-remove

`user-remove` will remove currently authenticated user from remote tsuru server. since there cannot exist any orphan teams, tsuru will refuse to remove a user that is the last member of some team. if this is your case, make sure you remove the team using `team-remove` before removing the user.

login
-----

.. highlight:: bash

::

    $ tsuru login [<email>]

Login will ask for the password and check if the user is successfully
authenticated. If so, the token generated by the **tsuru** server will be stored
in ${HOME}/.tsuru_token.

All tsuru actions require the user to be authenticated (except `login` and `version`).

logout
------

.. highlight:: bash

::

    $ tsuru logout

Logout will delete the token file and terminate the session within tsuru server.

Change user's password
----------------------

.. highlight:: bash

::

    $ tsuru change-password

`change-password` will change the password of the logged in user.
It will ask for the current password, the new and the confirmation.

Redefine user's password
------------------------

.. highlight:: bash

::

    $ tsuru reset-password <email> [--token|-k <token>]

`reset-password` will redefine the user password.
This process is composed by two steps:

- Token generation
- Password generation

In order to generate the token, users should run this command without the --token flag.
The token will be mailed to the user.

With the token in hand, the user can finally reset the password using the --token flag.
The new password will also be mailed to the user.

Team management
===============

Create a new team
-----------------

.. highlight:: bash

::

    $ tsuru team-create <team-name>

team-create will create a team for the user. tsuru requires a user to be a member of at least one team in order to create an app or a service instance.

.. note::

    When you create a team, you're automatically member of this team.

Remove a team from tsuru
------------------------

.. highlight:: bash

::

    $ tsuru team-remove <team-name>

team-remove will remove a team from tsuru server. You're able to remove teams that you're member of. A team that has access to any app cannot be removed. Before removing a team, make sure it does not have access to any app (see "app-grant" and "app-revoke" commands for details).

List teams that the user is member of
-------------------------------------

.. highlight:: bash

::

    $ tsuru team-list

team-list will list all teams that you are member of.

Add a user to a team
--------------------

.. highlight:: bash

::

    $ tsuru team-user-add <team-name> <user@email>

team-user-add adds a user to a team. You need to be a member of the team to be able to add another user to it.

Remove a user from a team
-------------------------

.. highlight:: bash

::


    $ tsuru team-user-remove <team-name> <user@email>

team-user-remove removes a user from a team. You need to be a member of the team to be able to remove a user from it.

.. note::

    A team can never have 0 users. If you are the last member of a team, you can't remove yourself from it.

List members of a team
----------------------

.. highlight:: bash

::

    $ tsuru team-user-list <teamname>

Apps
====

Display the list of available platforms
---------------------------------------

.. highlight:: bash

::

    $ tsuru platform-list

platform-list lists the available platforms. All platforms displayed in this list may be used to create new apps (see app-create).

Display the list of available plans
-----------------------------------

.. highlight:: bash

::

    $ tsuru  plan-list --human
    +-------------+---------+---------+-----------+---------+
    | Name        | Memory  | Swap    | Cpu Share | Default |
    +-------------+---------+---------+-----------+---------+
    | default     | 512 MB  | 1024 MB | 1024      | true    |
    +-------------+---------+---------+-----------+---------+

plan-list lists available plans that can be used when creating an app.

Create an app
-------------

.. highlight:: bash

::

    $ tsuru app-create <appname> <platform> [--plan/-p plan_name] [--team/-t team_owner]

`app-create` will create a new app using the given name and platform. For tsuru, a platform is provisioner dependent. To check the available platforms, use the command "platform-list" and to add a platform use the command "platform-add".

In order to create an app, you need to be member of at least one team. All teams that you are member (see "tsuru team-list") will be able to access the app.

The ``platform`` parameter is the name of the platform to be used when creating
the app. This will definer how tsuru understands and executes your app. The list
of available platforms can be found running ``tsuru platform-list``.

The ``--plan`` parameter defines the plan to be used. The plan specifies how
computational resources are allocated to your application. Typically this means
limits for memory and swap usage, and how much cpu share is allocated. The list of
available plans can be found running ``tsuru plan-list``.

If this parameter is not informed, tsuru will choose the plan with the ``default``
flag set to true.

The ``team`` parameter describes which team is responsible for the created app,
this is only needed if the current user belongs to more than one team, in which
case this parameter will be mandatory.

Remove an app
-------------

.. highlight:: bash

::

    $ tsuru app-remove [-a/--app appname]

`app-remove` removes an app. If the app is bound to any service instance, all binds will be removed before the app gets deleted (see "tsuru unbind"). You need to be a member of a team that has access to the app to be able to remove it (you are able to remove any app that you see in "tsuru app-list").

Listing your apps
-----------------

.. highlight:: bash

::

    $ tsuru app-list
    +-------------+-------------------------+-------------------------------------------+
    | Application | Units State Summary     | Ip                                        |
    +-------------+-------------------------+-------------------------------------------+
    | myblog      | 1 of 1 units in-service | myblog-838381.us-east-1-elb.amazonaws.com |
    +-------------+-------------------------+-------------------------------------------+

`app-list` will list all apps that you have access to.
App access is controlled by teams.
If your team has access to an app, then you have access to it.

Display information about an app
--------------------------------

.. highlight:: bash

::

    $ tsuru app-info [-a/--app name]

`app-info` will display some informations about an specific app (its state, platform, git repository, etc.). You need to be a member of a team that access to the app to be able to see informations about it.

See app's logs
--------------

.. highlight:: bash

::

    $ tsuru app-log [-a/--app appname] [-l/--lines numberOfLines] [-s/--source source] [-f/--follow]

Log will show log entries for an app. These logs are not related to the code of the app itself, but to actions of the app in tsuru server (deployments, restarts, etc.).

The --app flag is optional, see "Guessing app names" section for more details. The --lines flag is optional and by default its value is 10. The --source flag is optional.

Stop the app's application
--------------------------

.. highlight:: bash

::

    $ tsuru app-stop [-a/--app appname]

app-stop will stop the application.

Start the app's application
---------------------------

.. highlight:: bash

::

    $ tsuru app-start [-a/--app appname]

app-start will start the application.

Restart the app's application
-----------------------------

.. highlight:: bash

::

    $ tsuru app-restart [-a/--app appname]

app-restart will restart the application (as defined in Procfile) of the application.

Add new units to the app
------------------------

.. highlight:: bash

::

    $ tsuru unit-add <# of units> [-a/--app appname]

unit-add will add new units (instances) to an app. You need to have access to the app to be able to add new units to it.

Remove units from the app
-------------------------

.. highlight:: bash

::

    $ tsuru unit-remove <# of units> [-a/--app appname]

unit-remove will remove units (instances) from an app. You need to have access to the app to be able to remove units from it.

Swap the routing between two apps
---------------------------------

.. highlight:: bash

::

    $ tsuru app-swap <app1> <app2>

app-swap will swap the routing between two apps enabling blue/green deploy, zero downtime and make the rollbacks easier.

Change the app team owner
-------------------------

.. highlight:: bash

::

    $ tsuru app-set-team-owner <new-team-owner> [-a/--app appname]

Allow a team to access an app
-----------------------------

.. highlight:: bash

::

    $ tsuru app-grant <team-name> [-a/--app appname]

app-grant will allow a team to access an app. You need to be a member of a team that has access to the app to allow another team to access it.

Revoke from a team access to an app
-----------------------------------

.. highlight:: bash

::

    $ tsuru app-revoke <team-name> [-a/--app appname]

app-revoke will revoke the permission to access an app from a team. You need to have access to the app to revoke access from a team.

An app cannot be orphaned, so it will always have at least one authorized team.

Run an arbitrary command in the app machine
-------------------------------------------

.. highlight:: bash

::

    $ tsuru app-run <command> [commandarg1] [commandarg2] ... [commandargn] [-a/--app appname]

Run will run an arbitrary command in the app machine. Base directory for all commands is the root of the app. For example, in a Django app, "tsuru run" may show the following output:

.. highlight:: bash

::

    $ tsuru run polls ls
    app.yaml
    brogui
    deploy
    foo
    __init__.py
    __init__.pyc
    main.go
    manage.py
    settings.py
    settings.pyc
    templates
    urls.py
    urls.pyc

Deploy
------

.. highlight:: bash

::

    $ tsuru app-deploy [-a/--app <appname>] <file-or-dir-1> [file-or-dir-2] ... [file-or-dir-n]

`app-deploy` deploys set of files and/or directories to tsuru server. Some examples of calls are:

.. highlight:: bash

::

    $ tsuru app-deploy .
    $ tsuru app-deploy myfile.jar Procfile

Public Keys
===========

Add SSH public key to tsuru's git server
----------------------------------------

.. highlight:: bash

::

    $ tsuru key-add <key-name> <key-file>

key-add sends your public key to tsuru's git server.
The key will be added to the current logged in user.

Remove SSH public key from tsuru's git server
---------------------------------------------

.. highlight:: bash

::

    $ tsuru key-remove <key-name>

key-remove removes your public key from tsuru's git server.
The key will be removed from the current logged in user.

List SSH public keys
--------------------

.. highlight:: bash

::

    $ tsuru key-list

key-list lists the public keys registered in the current user account.

Services
========

List available services and instances
-------------------------------------

.. highlight:: bash

::

    $ tsuru service-list
    +----------+-----------+
    | Services | Instances |
    +----------+-----------+
    | mysql    |           |
    +----------+-----------+

service-list will retrieve and display a list of services that the user has access to. If the user has any instance of services, it will be displayed by this command too.

Create a new service instance
-----------------------------

.. highlight:: bash

::

    $ tsuru service-add <servicename> <serviceinstancename> [plan] [-t/--owner-team <team>]

service-add creates a new service instance.

Remove a service instance
-------------------------

.. highlight:: bash

::

    $ tsuru service-remove <serviceinstancename> [--assume-yes]

service-remove will destroy a service instance. It can't remove a service instance that is bound to an app, so before remove a service instance, make sure there is no apps bound to it (see "service-info" command).

Display information about a service
-----------------------------------

    $ tsuru service-info <service-name>

service-info will display a list of all instances of a given service (that the user has access to), and apps bound to these instances.


.. highlight:: bash

::

    $ tsuru service-info mysql
    Info for "mysql"
    +-----------+-------+
    | Instances | Apps  |
    +-----------+-------+
    | newmysql  |       |
    +-----------+-------+
    $ tsuru bind newmysql myapp
    ...
    $ tsuru service-info mysql
    Info for "mysql"
    +-----------+-------+
    | Instances | Apps  |
    +-----------+-------+
    | newmysql  | myapp |
    +-----------+-------+

Check if a service instance is up
---------------------------------

.. highlight:: bash

::

    $ tsuru service-status <instance-name>

service-status will display the status of the given service instance. For now, it checks only if the instance is "up" (receiving connections) or "down" (refusing connections).

Display the documentation of a service
--------------------------------------

.. highlight:: bash

::

    $ tsuru service-doc <service-name>

service-doc will display the documentation of a service.

Bind an application to a service instance
-----------------------------------------

.. highlight:: bash

::

    $ tsuru service-bind <service_instance_name> [--app appname]

service-bind will bind an application to a service instance (see service-add for more details on how to create a service instance).

When binding an application to a service instance, tsuru will add new environment variables to the app. All environment variables exported by bind will be private (not accessible via env-get).

Unbind an application from a service instance
---------------------------------------------

.. highlight:: bash

::

    $ tsuru service-unbind <service_instance_name> [--app appname]

service-unbind will unbind an application from a service instance. After unbinding, the instance will not be available anymore. For example, when unbinding an application from a MySQL service, the app would lose access to the database.

Guessing app names
==================

In some app-related commands (app-remove, app-info, app-grant, app-revoke,
log, run, restart, env-get, env-set, env-unset, bind and unbind), there is an
optional parameter --app, used to specify the name of the app.

The --app parameter is optional, if omitted, tsuru will try to "guess" the
name of the app based in the configuration of the git repository. It will try
to find a remove labeled "tsuru", and parse its url.

For example, if the file ".git/config" in you git repository contains the
following remote declaration:

.. highlight:: bash

::

    [remote "tsuru"]
    url = git@tsuruhost.com:gopher.git
    fetch = +refs/heads/*:refs/remotes/tsuru/*

When you run "tsuru app-info" without specifying the app, tsuru would display
information for the app "gopher".

Token
=====

tsuru users have a API key that enables authentication that don't required interaction.
The key never expires, to regenerate the API key you should use the command ``token-regenerate``.

.. highlight:: bash

::

    $ tsuru token-regenerate

To view the current key just use the command ``token-show``.

.. highlight:: bash

::

    $ tsuru token-show

Environment variables
=====================

All configurations in tsuru are handled by the use of environment variables.
If you need to connect with a third party service, e.g. twitter’s API,
you are probably going to need some extra configurations, like client_id.
In tsuru, you can export those as environment variables,
visible only by your application’s processes.

env-set
-------

.. highlight:: bash

::

    $ tsuru env-set <NAME=value> [NAME=value] ... [-a/--app appname]

This command sets environment variables for an app.

env-get
-------

.. highlight:: bash

::

    $ tsuru env-get [-a/--app appname] [ENVIRONMENT_VARIABLE1] [ENVIRONMENT_VARIABLE2] ...

This command retrieves environment variables for an app.

env-unset
---------

.. highlight:: bash

::

    $ tsuru env-unset <ENVIRONMENT_VARIABLE1> [ENVIRONMENT_VARIABLE2] ... [ENVIRONMENT_VARIABLEN] [-a/--app appname]

This command unsets environment variables for an app.

Plugin management
=================

Installing a plugin
-------------------

Let's install a plugin. There are two ways to install.  The first way is to
move your plugin to ``$HOME/.tsuru/plugins``.  The other way is to use ``tsuru
plugin-install`` command.


.. highlight:: bash

::

    $ tsuru plugin-install <plugin-name> <plugin-url>

``tsuru plugin-install`` will download the plugin file to
``$HOME/.tsuru/plugins``.  The syntax for this command is:

Listing installed plugins
-------------------------

.. highlight:: bash

::

    $ tsuru plugin-list
    plugin1
    plugin2

``plugin-list`` lists all installed plugins.

Executing a plugin
------------------

To execute a plugin just follow this pattern ``tsuru <plugin-name> <args>``:

.. highlight:: bash

::

    $ tsuru <plugin-name>
    <plugin-output>

Removing a plugin
-----------------

To remove a plugin just use the ``tsuru plugin-remove`` command passing the
name of the plugin as argument:

.. highlight:: bash

::

    $ tsuru plugin-remove <plugin-name>
    Plugin "<plugin-name>" successfully removed!

CNAME management
================

Add a CNAME to the app
----------------------

.. highlight:: bash

::

    $ tsuru cname-add <cname> [-a/--app appname]

cname-add will add a CNAME to the app. It will not manage any DNS register, it's up to the user to create the DNS register. Once the app contains a custom CNAME, it will be displayed by "app-list" and "app-info".

Remove a CNAME from the app
---------------------------

.. highlight:: bash

::

    $ tsuru cname-remove [-a/--app appname]

cname-remove undoes the change that cname-add does. After unsetting the CNAME from the app, "app-list" and "app-info" will display the internal, unfriendly address that tsuru uses.

Auto Scale
==========

Configure auto scale
--------------------

.. highlight:: bash

::

    $ tsuru autoscale-config [-a/--app appname] [--max-units unitsnumber] [--min-units unitsnumber] [--increase-step unitsnumber] [--increase-wait-time seconds] [--increase-expression expression] [--decrease-wait-time seconds] [--decrease-expression expression] [--enabled]

Enable auto scale
-----------------

.. highlight:: bash

::

    $ tsuru autoscale-enable [-a/--app appname]

Disable auto scale
------------------

.. highlight:: bash

::

    $ tsuru autoscale-disable [-a/--app appname]
